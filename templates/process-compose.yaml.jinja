version: "0.1"

processes:
  postgres:
    command: 'postgres -p{{ postgresql_port }} -k ${XDG_STATE_HOME} -c logging_collector=off -c log_destination=stderr -c log_min_messages=INFO -c log_statement=all'
    is_daemon: true
    readiness_probe:
      exec:
      command: "pg_isready -p{{ postgresql_port }}"
      interval: 5s
    environment:
      - PGDATA=${PGDATA}
      - PGHOST=${PGHOST}
    availability:
      restart: "always"
    shutdown:
      command: "pg_ctl stop -D ${PGDATA} -m fast"
      signal: 2  # INT
      timeout: 30s

#   memcached:
#     command: "memcached -u nobody -m 64 -p {{ memcached_port }}"
#     shutdown:
#       signal: 15  # TERM
#       timeout: 10s
#     readiness_probe:
#       exec:
#         command: "ss -tanl | grep {{ memcached_port }}"
#       interval: 5s
#       timeout: 2s
#
#   rabbitmq:
#     command: "rabbitmq-server"
#     shutdown:
#       command: "rabbitmqctl stop"
#       timeout: 20s
#     readiness_probe:
#       exec:
#         command: "rabbitmqctl -n ${RABBITMQ_NODENAME} status"
#       interval: 5s
#       initial_delay: 10s
#       timeout: 3s
